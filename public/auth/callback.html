<!-- public/auth/callback.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Authenticating...</title>
    <script type="module">
        import { supabase } from '../../src/js/supabase.js'

        // Handle the OAuth callback
        supabase.auth.getSession().then(({ data: { session } }) => {
            if (session?.user) {
                // Check user role and redirect accordingly
                supabase
                    .from('users')
                    .select('role')
                    .eq('id', session.user.id)
                    .single()
                    .then(({ data: userData }) => {
                        try {
                            const stored = sessionStorage.getItem('redirectAfterAuth')
                            sessionStorage.removeItem('redirectAfterAuth')
                            if (userData?.role === 'admin') {
                                window.location.href = '/admin.html'
                            } else {
                                const fallback = '/index.html'
                                const dest = stored && typeof stored === 'string' ? stored : fallback
                                window.location.href = dest
                            }
                        } catch (_) {
                            window.location.href = '/index.html'
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching user role:', error)
                        window.location.href = '/index.html'
                    })
            } else {
                window.location.href = '/login.html'
            }
        })
    </script>
</head>
<body>
    <p>Authenticating, please wait...</p>
</body>
</html>